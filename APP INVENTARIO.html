<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventario</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#ffffff;color:#000}
header{text-align:center;padding:16px;border-bottom:1px solid #ddd}
main{max-width:900px;margin:auto;padding:16px}
button{cursor:pointer;border:1px solid #ccc;border-radius:10px;padding:10px 16px;background:#f5f5f5;font-size:16px}
button:active{transform:scale(0.98)}
button.danger{background:#ffe5e5;border-color:#ffaaaa}
.card{background:#fff;border:1px solid #ddd;border-radius:14px;padding:16px;margin-bottom:16px}
.actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
#scanner{width:100%;max-width:420px;margin:10px auto;border:2px solid #333;border-radius:8px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:10px;text-align:center}
th{background:#f5f5f5}
input[type=number]{width:80px;padding:6px;border-radius:6px;border:1px solid #ccc}
.note{font-size:14px;color:#555;text-align:center}
</style>
</head>
<body>
<header>
  <h1>Inventario</h1>
</header>
<main>

  <div class="card">
    <div class="actions">
      <button id="startScan">ðŸ“· Escanear cÃ³digo</button>
      <button id="exportExcel">â¬‡ Descargar Excel</button>
      <button id="resetApp" class="danger">â™» Resetear</button>
    </div>
    <div id="scanner"></div>
    <p class="note">En Android: abre esta app desde una URL (localhost o servidor). No funciona desde archivo local.</p>
  </div>

  <div class="card">
    <h2>Inventario</h2>
    <table>
      <thead>
        <tr>
          <th>Referencia</th>
          <th>Unidades</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>
  </div>

</main>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
// ====== DATOS ======
const STORAGE_KEY = 'inventario_scanner_android';
let inventario = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
const tabla = document.getElementById('tabla');

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(inventario));
}

function render(){
  tabla.innerHTML='';
  inventario.forEach((item, idx)=>{
    const tr=document.createElement('tr');

    const tdRef=document.createElement('td');
    tdRef.textContent=item.referencia;

    const tdQty=document.createElement('td');
    const inp=document.createElement('input');
    inp.type='number';
    inp.min=0;
    inp.value=item.unidades;
    inp.onchange=()=>{
      inventario[idx].unidades = Number(inp.value)||0;
      save();
    };
    tdQty.appendChild(inp);

    const tdDel=document.createElement('td');
    const btn=document.createElement('button');
    btn.textContent='ðŸ—‘';
    btn.className='danger';
    btn.onclick=()=>{
      if(confirm('Â¿Eliminar esta fila?')){
        inventario.splice(idx,1);
        save();
        render();
      }
    };
    tdDel.appendChild(btn);

    tr.append(tdRef, tdQty, tdDel);
    tabla.appendChild(tr);
  });
}

render();

// ====== ESCÃNER ======
document.getElementById('startScan').onclick=()=>{
  if(location.protocol==='file:'){
    alert('En Android la cÃ¡mara no funciona desde archivos locales.\n\nAbre esta app desde una URL (localhost o servidor).');
    return;
  }

  navigator.mediaDevices.getUserMedia({video:true}).then(()=>{
    Quagga.init({
      inputStream:{
        type:'LiveStream',
        target:document.getElementById('scanner'),
        constraints:{facingMode:'environment'}
      },
      decoder:{
        readers:['ean_reader','ean_8_reader','code_128_reader','code_39_reader']
      }
    },err=>{
      if(err){alert('No se pudo iniciar la cÃ¡mara');return;}
      Quagga.start();
    });

    Quagga.onDetected(data=>{
      if(data.codeResult.format==='qr_code') return;
      const ref=data.codeResult.code;

      // Si ya existe, suma 1
      const found=inventario.find(i=>i.referencia===ref);
      if(found){
        found.unidades+=1;
      }else{
        inventario.push({referencia:ref,unidades:1});
      }
      save();
      render();
      Quagga.stop();
    });
  }).catch(()=>alert('Permiso de cÃ¡mara denegado'));
};

// ====== EXPORTAR EXCEL ======
document.getElementById('exportExcel').onclick=()=>{
  if(!inventario.length){alert('No hay datos para exportar');return;}
  let csv='Referencia,Unidades\n';
  inventario.forEach(i=>csv+=`${i.referencia},${i.unidades}\n`);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='inventario.xlsx';
  a.click();
};

// ====== RESET ======
document.getElementById('resetApp').onclick=()=>{
  if(confirm('Â¿Seguro que quieres borrar todo el inventario?')){
    inventario=[];
    save();
    render();
  }
};
</script>
<script>
// Registrar Service Worker para PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js');
}
</script>
</body>
</html>
